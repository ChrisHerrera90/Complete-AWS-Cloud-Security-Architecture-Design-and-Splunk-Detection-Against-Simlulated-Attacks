# Phase 6: Splunk Log Ingestion Setup
In This phase, I will use Terraform to build out a Linux server and install/configure Splunk Enterprise for log aggregation across the AWS environment. I will also create two additional Windows EC2 instances within the private subnet that will act as "workstations" that will be targeted later during our simulated attacks.

## üéØ Main Target Goals for this Phase:
- Configure Splunk Ubuntu server so it can receive logs.
- Forward Sysmon logs from all Windows EC2s to Splunk
- Forward Active Directory logs to Splunk
- Forward all AWS services logs to Splunk (Guard Duty, Cloud Trail, Cloudwatch, VPC flow logs, and IAM Acces Analyser)

---

## üîß Technology Utilized
- Terraform
- AWS EC2 with Windows Server 2022
- Windows AD Domain Controller
- Active Directory and Group Policies
- AWS Security Groups
- Sysmon
- AWS Guard Duty, Cloud Trail, Cloudwatch, VPC flow logs, and IAM Acces Analyser

---

## üìΩÔ∏è Video: Lessons Learned

[![Watch the video](https://img.youtube.com/vi/vQeKo0BsaKw/0.jpg)](https://youtu.be/vQeKo0BsaKw)

---

# Table of Contents

- [Creating Sec Group Outbound rule for workstations to communicate with AD Server](#creating-sec-group-outbound-rules-for-workstations-to-communicate-with-ad-server)
- [Adding Workstations to my Domain Controller](#setting-the-workstation-to-join-my-ad-domain-controller)
- [Installing Sysmon on all my EC2s for Logging](#installing-sysmon-on-my-4-windows-ec2s)
- [Creating AD Group Policy Objects for Windows Workstations](#creating-ad-group-policies-for-my-windows-workstations)
- [Creating a new IAM User with permissions to manage AWS monitoring services](#-step-2-creating-a-new-iam-user-with-permissions-to-configure-aws-security-monitoring-services)
- [Configuring AWS monitoring services withing AWS dashboard](#-step-3-configuring-aws-security-monitoring-services)


---

## ‚≠ê Step 1Ô∏è: Configuring Splunk to Receive Logs

Before I setup log forwarding, I first need to ensure that my Splunk server is set up to actually receive logs. Specifically, I need to make sure that:
1. The correct ports are open in the Splunk/Ubuntu EC2 security group for log traffic
2. Setup my Splunk account to receive logs from sysmon and windows AD logs.
3. Enable HTTP Event Collector (HEC) so that AWS logs can be forwarded to Splunk
4. Install "Splunk Add Ons" for AWS services and Microsoft Windows so that Splunk can properly parse these logs.


### Ensuring the Correct Ports are Open in the Ubuntu Security Group

In order for my Splunk EC2 to receive logs, I first needed to open up the following inbound ports from the security group:
- TCP 9997 for Splunk Universal Forwarder logs generated by my EC2s (Sysmon, AD, etc.)
- TCP 8088 for AWS services logs forwarded through HEC.
- TCP 8000 for Splunk GUI access from my Bastion server.

![image](https://github.com/user-attachments/assets/4f3b2240-f872-4772-b26e-2bbbb02c34d3)


#### Setup My Splunk Account to Receive Sysmon/AD Logs via Port 9997

Now that I have opened up the security group, I next have to go into my Splunk account and enable the receiving of Sysmon/AD logs via port 9997.

After confirming that Splunk was running in my Ubuntu machine, I then used my Bastion VM to open up a browser and log into my Splunk account via the DNS of the Ubuntu/Splunk server (it doesn't have a Public IP) to access the Splunk web UI using the following:

`http://<SPLUNKEC2-PUBLIC-DNS>:8000`

![image](https://github.com/user-attachments/assets/0243d612-f4ff-490d-97b8-bb83bffcd8dc)

![image](https://github.com/user-attachments/assets/9d327a64-ba3c-4429-871b-a2b0d7c50193)


**‚ö†Ô∏èNOTE‚ö†Ô∏è**: 
Bastion could not connect to the internet initially, I kept getting error messages that DNS could not be found for the URLS. Eventually, I discovered that when I added my Bastion Ec2 to my Windows AD domain controller (and changed the domain name) it automatically stops using Public DNS servers like Google's 8.8.8.8, and instead, switches to my domain controller's private IP as a DNS server; and thus I lose internet name resolution/internet connection. To resolve this, I had to log into my Windows AD Domain controller EC2 and setup up domain forwarding to 8.8.8.8 and 8.8.4.4 (And update outbound DNS rules to connect to 8.8.8.8) so that I can re-establish internet access to my EC2s connected to my Domain Controller!

Once I fixed the DNS name resolution issue, I went ahead and visited `http://<SPLUNKEC2-PUBLIC-DNS>:8000` and logged into my Splunk account web UI. To enable port 9997, I navigated to the following settings:

`Settings ‚Üí Forwarding and receiving ‚Üí Configure receiving ‚Üí Enable port 9997`

![image](https://github.com/user-attachments/assets/449a4a81-75c9-4fc7-8039-199f79fb0206)
![image](https://github.com/user-attachments/assets/d275e688-fd58-4e29-8ca0-3af90b33b022)
![image](https://github.com/user-attachments/assets/44caaa1a-58bc-4ab7-9d45-a0c09177223d)
![image](https://github.com/user-attachments/assets/88fc44f1-9210-4d75-8f1e-285049e39b23)


#### Configuring the HTTP Event Collector (HEC) to Forward AWS Logs into Splunk

Next I am going to configure HEC so that my AWS monitoring services has the ability to forward their logs to my Splunk. HEC allows AWS to transmit log data via HTTPS/HTTP to Splunk using an authentication token. The token replaces the need to utilize my Splunk credentials for convenience and extra security.

HEC setup was fairly simple, In my Splunk web UI I navigated to the following settings:

`Settings ‚Üí Data Inputs ‚Üí HTTP Event Collector`

From here I created a `New Token` and added the following configurations for EACH service:
- Name: `AWS_Log_Collector`
- Source Types: `aws:cloudtrail`, `aws:guardduty`, `aws:cloudwatch:vpcflow`, and `aws:accessanalyzer`
- Enable Token (I saved the tokens for later use)
- Indexed is as `aws_logs` (for querying in Splunk)

![image](https://github.com/user-attachments/assets/4419965a-7665-4606-991e-1f180386b84c)
![image](https://github.com/user-attachments/assets/b1a072b2-9db8-4e45-8991-1c7cb8f05ccd)
![image](https://github.com/user-attachments/assets/5471bef2-0882-4b9f-bd07-e44f3b448672)
![image](https://github.com/user-attachments/assets/c9a1988f-f485-4897-a754-16c366b9c241)
![image](https://github.com/user-attachments/assets/0d5239a6-ad39-47c4-be8b-7d92d3a5c28c)

I repeated this step for all the AWS services (Cloudtrail, GuardDuty, CloudWatch, VPC Flow logs, IAM access analyzer)

Finally, I had to enable these tokens by navigating into the `Global Settings` and clicking `Enabled`. If these are not enabled, then Splunk will reject any logs that are sent to them.

![image](https://github.com/user-attachments/assets/b51d6112-67d0-45f3-8f93-968bd16549fe)
![image](https://github.com/user-attachments/assets/aec07908-fd1c-42e9-8dee-736e403252fe)

---

### Installing Add-ons for Parsing AWS & Windows Logs Correctly

These add-ons tell Splunk how to parse and recognize fields from AWS and Windows log formats. To do this, I will download the `.tgz` from Splunk and upload them in the following location within the Splunk web UI:

`Apps ‚Üí Manage Apps ‚Üí Install App from File`

![image](https://github.com/user-attachments/assets/68f36b84-b95c-40eb-a7a2-24b03a06050f)
![image](https://github.com/user-attachments/assets/a96000f1-f7c3-4756-89a9-7d16be541d20)
![image](https://github.com/user-attachments/assets/893e3ccd-2382-4ec6-a7c7-84e753bad55e)

I repeated this for both AWS and Microsoft Add Ons. I then confirmed they were successfully installed by reviewing them in the `APP` section of Splunk:

![image](https://github.com/user-attachments/assets/8c9797c6-a6d0-4b8c-9c2a-1ab261ec53e2)


---
---
## ‚≠ê Step 2: Installing Splunk Universal Forwarder into All My EC2s


---
---   
## ‚≠ê Step 3: Configure AWS Services to Send Logs to Splunk via HEC

---
--



## Now that I have set up my monitoring and detection services/tools, we are ready for [Phase 6 - Splunk Log Ingestion Setup](https://github.com/ChrisHerrera90/Complete-AWS-Cloud-Security-Architecture-Design-and-Splunk-Detection-Against-Simlulated-Attacks/blob/main/Phase%206%20-%20Splunk%20Log%20Ingestion%20Setup/Phase%206%20README.md)
