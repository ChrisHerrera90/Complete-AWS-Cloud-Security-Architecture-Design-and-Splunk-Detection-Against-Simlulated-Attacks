# Phase 6: Splunk Log Ingestion Setup
In This phase, I will use Terraform to build out a Linux server and install/configure Splunk Enterprise for log aggregation across the AWS environment. I will also create two additional Windows EC2 instances within the private subnet that will act as "workstations" that will be targeted later during our simulated attacks.

## üéØ Main Target Goals for this Phase:
- Configure Splunk Ubuntu server so it can receive logs.
- Forward Sysmon logs from all Windows EC2s to Splunk
- Forward Active Directory logs to Splunk
- Forward all AWS services logs to Splunk (Guard Duty, Cloud Trail, Cloudwatch, VPC flow logs, and IAM Acces Analyser)

---

## üîß Technology Utilized
- Terraform
- AWS EC2 with Windows Server 2022
- Windows AD Domain Controller
- Active Directory and Group Policies
- AWS Security Groups
- Sysmon
- AWS Guard Duty, Cloud Trail, Cloudwatch, VPC flow logs, and IAM Acces Analyser

---

## üìΩÔ∏è Video: Lessons Learned

[![Watch the video](https://img.youtube.com/vi/vQeKo0BsaKw/0.jpg)](https://youtu.be/vQeKo0BsaKw)

---

# Table of Contents

- [Creating Sec Group Outbound rule for workstations to communicate with AD Server](#creating-sec-group-outbound-rules-for-workstations-to-communicate-with-ad-server)
- [Adding Workstations to my Domain Controller](#setting-the-workstation-to-join-my-ad-domain-controller)
- [Installing Sysmon on all my EC2s for Logging](#installing-sysmon-on-my-4-windows-ec2s)
- [Creating AD Group Policy Objects for Windows Workstations](#creating-ad-group-policies-for-my-windows-workstations)
- [Creating a new IAM User with permissions to manage AWS monitoring services](#-step-2-creating-a-new-iam-user-with-permissions-to-configure-aws-security-monitoring-services)
- [Configuring AWS monitoring services withing AWS dashboard](#-step-3-configuring-aws-security-monitoring-services)


---

## ‚≠ê Step 1Ô∏è: Configuring Splunk to Receive Logs

Before I setup log forwarding, I first need to ensure that my Splunk server is set up to actually receive logs. Specifically, I need to make sure that:
1. The correct ports are open in the Splunk/Ubuntu EC2 security group for log traffic
2. Setup my Splunk account to receive logs from sysmon and windows AD logs.
3. Create a "data input" for each type of logs that will be received in Splunk.
4. Enable HTTP Event Collector (HEC) so that AWS logs can be forwarded to Splunk
5. Install "Splunk Add Ons" for AWS services and Microsoft Windows so that Splunk can properly parse these logs.


### Ensuring the Correct Ports are Open in the Ubuntu Security Group

In order for my Splunk EC2 to receive logs, I first needed to open up the following inbound ports from the security group:
- TCP 9997 for Splunk Universal Forwarder logs generated by my EC2s (Sysmon, AD, etc.)
- TCP 8088 for AWS services logs forwarded through HEC.
- TCP 8000 for Splunk GUI access from my Bastion server.

![image](https://github.com/user-attachments/assets/4f3b2240-f872-4772-b26e-2bbbb02c34d3)




#### Setup My Splunk Account to Receive Sysmon/AD Logs via Port 9997

Now that I have opened up the security group, I next have to go into my Splunk account and enable the receiving of Sysmon/AD logs via port 9997.



After confirming that Splunk was running in my Ubunutu machine, I then used my Bastion VM to open up a browser and log into my Splunk account via the DNS of the Ubunut/Splunk server (doesn't have a Public IP) to access the Splunk web UI using the following:

`http://<SPLUNKEC2-PUBLIC-DNS>:8000`


**‚ö†Ô∏èNOTE‚ö†Ô∏è**: 
Bastion could not connect to the internet initially, I kept getting error messages that DNS could not be found for the URLS. Eventually, I discovered that when I added my Bastion Ec2 to my Windows AD domain controller (and changed the domain name) it automatically stops using Public DNS servers like Google's 8.8.8.8, and instead, switches to my domain controller's private IP as a DNS server; and thus I lose internet name resolution/internet connection. To resolve this, I had to log into my Windows AD Domain controller EC2 and setup up domain forwarding to 8.8.8.8 and 8.8.4.4 (And update outbound DNS rules to connect to 8.8.8.8) so that I can re-establish internet access to my EC2s connected to my Domain Controller!


![image](https://github.com/user-attachments/assets/0243d612-f4ff-490d-97b8-bb83bffcd8dc)

![image](https://github.com/user-attachments/assets/9d327a64-ba3c-4429-871b-a2b0d7c50193)



To keep things simple, I decided to enable this via the Splunk web UI by navigating to the following settings:

`Settings ‚Üí Forwarding and receiving ‚Üí Configure receiving ‚Üí Enable port 9997`

















#### Windows AD OUTBOUND traffic rules to 10.0.2.80 AND 10.0.2.90 (Windows Workstations Private IP):
- Port 445 open to 10.0.2.80/10.0.2.90 (SMB communication)


---

### Setting the Workstation to Join My AD Domain Controller

Once I have the right ports open for communication, my next step is to bastion into my first workstation and change it's domain settings so it can point to the [Active Directory domain that we created in Phase 3:](https://github.com/ChrisHerrera90/Complete-AWS-Cloud-Security-Architecture-Design-and-Splunk-Detection-Against-Simlulated-Attacks/blob/main/Phase%203:%20Windows%20Active%20Directory%20Server%20EC2%20Instance%20Deployment%20and%20Setup/Phase%203%20README.md#rdp-into-windows-ad-ec2-and-installing-active-directory-and-upgrading-it-to-the-domain-controller) `aws-securityproject.local`


---

### Installing Sysmon on my 4 Windows EC2s

Before I configure my Group Policies in AD, I will need to install Sysmon (System Monitor) on all of my Windows EC2s so that I can log detailed events about process creation, network connections, and file changes across my environment. This will help supplement data that standard Windows Event Logs do not provide.


---

### Creating AD Group Policies for my Windows Workstations

In order to start retrieving event logs from my Workstations for my simulated attacks, I begin by creating a new Organizationl Unit (OU) within my `aws-securityproject.local` domain. I will call it `EC2 Workstations OU`:


### Once the new GPO is created, I will then edit it to include the following policies:


#### ‚úÖ Enable Command Line Logging
Group Policy Management Editor Location: `Computer Configuration > Administrative Templates > System > Audit Process Creation`




---
---
## ‚≠ê Step 2: Creating a new IAM User with Permissions to Configure AWS Security Monitoring Services


---
---   
## ‚≠ê Step 3: Configuring AWS Security Monitoring Services

---
--



## Now that I have set up my monitoring and detection services/tools, we are ready for [Phase 6 - Splunk Log Ingestion Setup](https://github.com/ChrisHerrera90/Complete-AWS-Cloud-Security-Architecture-Design-and-Splunk-Detection-Against-Simlulated-Attacks/blob/main/Phase%206%20-%20Splunk%20Log%20Ingestion%20Setup/Phase%206%20README.md)
